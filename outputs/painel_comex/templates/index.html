<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Inteligência</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="container">
    
    <!-- ===================== SIDEBAR ===================== -->
    <aside class="sidebar">
      <div class="logo">JubartData</div>
      
      <!-- Navegação principal -->
      <nav>
        <ul>
          <li class="{% if pagina == 'overview' %}active{% endif %}">
            <a href="/overview?tipo={{ tipo }}&ano={{ ano_atual }}&filtro={{ filtro }}&filtro_secundario={{ filtro_secundario }}">Overview</a>
          </li>
          <li class="{% if pagina == 'market' %}active{% endif %}">
            <a href="/market?tipo={{ tipo }}&ano={{ ano_atual }}&filtro={{ filtro }}&filtro_secundario={{ filtro_secundario }}">Market</a>
          </li>
          <li class="{% if pagina == 'ncm' %}active{% endif %}">
            <a href="/ncm?tipo={{ tipo }}&ano={{ ano_atual }}">NCM</a>
          </li>
          <li>Product</li>
        </ul>
      </nav>

      <!-- Seletor de ano -->
      <div class="year-selector">
        <button class="year-btn" onclick="atualizarAno({{ ano_atual - 1 }})">{{ ano_atual -1 }}</button>
        <button class="year-btn" onclick="atualizarAno({{ ano_atual }})">{{ ano_atual }}</button>
      </div>

      <!-- Seletor de tipo de dado -->
      <div class="data-selector">
        <label for="tipo-dado">Tipo de dado:</label>
        <select id="tipo-dado" onchange="atualizarURL()">
          <option value="impo" {% if tipo == 'impo' %}selected{% endif %}>Importação</option>
          <option value="expo" {% if tipo == 'expo' %}selected{% endif %}>Exportação</option>
        </select>
      </div>

      <!-- Filtros principais -->
      <div class="data-selector">
        <label for="filtro">Filtrar por:</label>
        <select id="filtro" onchange="atualizarURL()">
          <option value="uf" {% if filtro == 'uf' %}selected{% endif %}>UF</option>
          <option value="paises" {% if filtro == 'paises' %}selected{% endif %}>Países</option>
          <option value="especie" {% if filtro == 'especie' %}selected{% endif %}>Espécie</option>
          <option value="categoria" {% if filtro == 'categoria' %}selected{% endif %}>Categoria</option>
          <option value="ncm" {% if filtro == 'ncm' %}selected{% endif %}>NCM</option>
          <option value="descricaoncm" {% if filtro == 'descricaoncm' %}selected{% endif %}>Descrição NCM</option>
        </select>
      </div>

      <!-- Agrupar por -->
      <div class="data-selector">
        <label for="filtro_secundario">Agrupar por:</label>
        <select id="filtro_secundario" onchange="atualizarURL()"></select>
      </div>

      <!-- Rodapé da sidebar -->
      <div class="sidebar-footer">JubartData</div>
    </aside>

    <!-- ===================== CONTEÚDO PRINCIPAL ===================== -->
    <main class="main">
      
      <!-- Cabeçalho dinâmico -->
      <header class="topbar">
        {% if pagina == "overview" %}
          <h1>Market Overview</h1>
        {% elif pagina == "market" %}
          <h1>Market Details</h1>
        {% elif pagina == "ncm" %}
          <h1>Consulta por NCM</h1>
        {% endif %}
      </header>

      <!-- ========== BLOCO ESPECÍFICO PARA NCM ========== -->
      {% if pagina == "ncm" %}
      <section>
        <label for="ncm-select">Selecione um NCM:</label>
        <select id="ncm-select">
          <option value="">-- Escolha um NCM --</option>
          {% for ncm in ncm_list %}
            <option value="{{ ncm }}">{{ ncm }}</option>
          {% endfor %}
        </select>

        <!-- Gráfico histórico do NCM -->
        <div class="chart chart-large" id="grafico_ncm">
          {{ grafico_volume|safe }}
        </div>
      </section>
      
      <!-- ========== BLOCO PADRÃO (OVERVIEW E MARKET) ========== -->
      {% else %}
        <!-- Métricas -->
        <section class="metrics">
          <div class="metric-card">
            <div class="metric-title">Volume (toneladas)</div>
            <div class="metric-value">{{ volume }}</div>
            <div class="metric-change" style="color: {{ cor_volume }}">{{ var_volume }}</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Valor (USD x 1000)</div>
            <div class="metric-value">{{ valor }}</div>
            <div class="metric-change" style="color: {{ cor_valor }}">{{ var_valor }}</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Preço Médio (USD/kg)</div>
            <div class="metric-value">{{ preco }}</div>
            <div class="metric-change" style="color: {{ cor_preco }}">{{ var_preco }}</div>
          </div>
        </section>

        <!-- Linha superior de gráficos -->
        <section class="charts-row">
          <div class="chart chart-large">{{ grafico_volume|safe }}</div>
          <div class="chart chart-small">{{ grafico_evolucao|safe }}</div>
        </section>

        <!-- Linha inferior de gráficos -->
        <section class="charts-row charts-trio">
          <div class="chart chart-small">{{ grafico_categoria|safe }}</div>
          <div class="chart chart-small">{{ grafico_segmento|safe }}</div>
          <div class="chart chart-small">{{ grafico_quantidade|safe }}</div>
        </section>
      {% endif %}
    </main>
  </div>

  <!-- ===================== SCRIPTS ===================== -->
  <script>
    // Força o redimensionamento dos gráficos após o carregamento
    window.addEventListener('load', function () {
      window.dispatchEvent(new Event('resize'));
    });

    // Atualiza URL ao mudar o ano
    function atualizarAno(novoAno) {
      const params = new URLSearchParams(window.location.search);
      const tipo = document.getElementById("tipo-dado").value || params.get("tipo") || "impo";
      const filtro = document.getElementById("filtro").value || params.get("filtro") || "uf";
      const filtro_secundario = document.getElementById("filtro_secundario").value || params.get("filtro_secundario") || "paises";
      const query = new URLSearchParams({ tipo, ano: novoAno, filtro, filtro_secundario }).toString();
      location.href = "/?" + query;
    }

    // Atualiza URL ao mudar tipo/filtro
    function atualizarURL() {
      const tipo = document.getElementById("tipo-dado").value;
      const params = new URLSearchParams(window.location.search);
      const ano = params.get("ano") || "{{ ano_atual }}";
      const filtro = document.getElementById("filtro").value;
      const filtro_secundario = document.getElementById("filtro_secundario").value;
      const query = new URLSearchParams({ tipo, ano, filtro, filtro_secundario }).toString();
      location.href = "/?" + query;
    }

    // Inicializa interações ao carregar DOM
    window.addEventListener('DOMContentLoaded', () => {
      // === Preenche filtro secundário ===
      const params = new URLSearchParams(window.location.search);
      const filtroSelecionado = params.get("filtro") || "uf";
      const filtroSecSelecionado = params.get("filtro_secundario");
      document.getElementById("filtro").value = filtroSelecionado;

      const secundarioSelect = document.getElementById("filtro_secundario");
      secundarioSelect.innerHTML = "";
      const opcoesFiltro = ["uf", "paises", "especie", "categoria", "ncm", "descricaoncm"];
      opcoesFiltro.filter(op => op !== filtroSelecionado).forEach(op => {
        const option = document.createElement("option");
        option.value = op;
        option.textContent = op.charAt(0).toUpperCase() + op.slice(1);
        if (filtroSecSelecionado === op) option.selected = true;
        secundarioSelect.appendChild(option);
      });

      // === Evento: Seleção de NCM ===
      const ncmSelect = document.getElementById("ncm-select");
      if (ncmSelect) {
        ncmSelect.addEventListener("change", function () {
          const ncmSelecionado = this.value;
          if (ncmSelecionado) {
            const params = new URLSearchParams(window.location.search);
            params.set("ncm", ncmSelecionado);
            window.location.search = params.toString();
          }
        });
      }
    });
  </script>

</body>
</html>
